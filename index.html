<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gewichtsprüfung</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Gewicht">
  <meta name="theme-color" content="#111111">

  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --border:#e3e6f2;
      --pill:#f2f4ff; --ok:#e9fbf0; --bad:#ffecec;
      --btn:#111; --btnText:#fff; --btnSecondary:#eef0f8; --btnSecondaryText:#111;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --warnBorder:rgba(198,40,40,.45); --warnGlow:0 0 0 4px rgba(198,40,40,.10);
      --modalBg: rgba(0,0,0,.35);
      --barBg: rgba(255,255,255,.92);
    }

    @media (prefers-color-scheme: dark){
      :root[data-theme="auto"]{
        --bg:#0b0d12; --card:#121521; --text:#f2f3f5; --muted:#a8b0c0; --border:#232a3b;
        --pill:#171c2a; --ok:rgba(46,204,113,.15); --bad:rgba(231,76,60,.18);
        --btn:#f2f3f5; --btnText:#111; --btnSecondary:#1b2133; --btnSecondaryText:#f2f3f5;
        --shadow:0 10px 30px rgba(0,0,0,.45);
        --warnBorder:rgba(255,90,90,.55); --warnGlow:0 0 0 4px rgba(255,90,90,.12);
        --modalBg: rgba(0,0,0,.55);
        --barBg: rgba(18,21,33,.92);
      }
    }
    :root[data-theme="dark"]{
      --bg:#0b0d12; --card:#121521; --text:#f2f3f5; --muted:#a8b0c0; --border:#232a3b;
      --pill:#171c2a; --ok:rgba(46,204,113,.15); --bad:rgba(231,76,60,.18);
      --btn:#f2f3f5; --btnText:#111; --btnSecondary:#1b2133; --btnSecondaryText:#f2f3f5;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --warnBorder:rgba(255,90,90,.55); --warnGlow:0 0 0 4px rgba(255,90,90,.12);
      --modalBg: rgba(0,0,0,.55);
      --barBg: rgba(18,21,33,.92);
    }

    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    .wrap { max-width: 980px; margin:0 auto; padding:18px; padding-bottom: 130px; }
    .card { background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--shadow); border:1px solid transparent; }
    .card.warn{ border-color: var(--warnBorder); box-shadow: var(--shadow), var(--warnGlow); }

    .header{ display:flex; align-items:center; gap:10px; }
    .logo{ width:72px; height:auto; }
    h1{ margin:0; font-size:18px; }
    .sub{ margin:2px 0 0; font-size:12px; color:var(--muted); }
    .status{ display:inline-block; margin-top:6px; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(46,204,113,.15); border:1px solid rgba(46,204,113,.35); }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px; }
    @media (max-width: 820px){ .grid{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, textarea{
      width:100%; padding:12px 12px; font-size:16px;
      border:1px solid var(--border); border-radius:12px; outline:none;
      background:var(--card); color:var(--text);
    }
    textarea{ min-height:44px; resize:vertical; }

    .pill{ display:flex; justify-content:space-between; gap:12px; padding:12px; border-radius:14px; background:var(--pill); margin-top:10px; }
    .pill strong{ font-weight:900; }
    .ok{ background:var(--ok); }
    .bad{ background:var(--bad); }

    button{
      cursor:pointer; border:0; padding:12px 14px; border-radius:12px;
      background:var(--btn); color:var(--btnText); font-weight:900; font-size:15px;
    }
    button.secondary{ background:var(--btnSecondary); color:var(--btnSecondaryText); }

    .bottomBar{
      position: fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: var(--barBg);
      border-top: 1px solid var(--border);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      z-index: 9998;
    }
    .bottomInner{
      max-width: 980px; margin:0 auto;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .group{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .tableWrap{ margin-top:12px; overflow:auto; border:1px solid var(--border); border-radius:12px; }
    table{ width:100%; border-collapse:collapse; min-width: 860px; }
    th, td{ padding:10px; border-bottom:1px solid rgba(227,230,242,.45); font-size:13px; text-align:left; }
    th{ font-size:12px; color:var(--muted); background: rgba(250,251,255,.6); position: sticky; top:0; }
    tr:last-child td{ border-bottom:0; }
    .right{ text-align:right; }

    .modalOverlay{
      display:none; position:fixed; inset:0; background:var(--modalBg);
      padding:18px; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      width:min(520px,100%); background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:14px; box-shadow:var(--shadow);
    }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .optRow{ display:flex; justify-content:space-between; gap:10px; align-items:center; padding:10px 0; border-bottom:1px solid rgba(227,230,242,.45); }
    .optRow:last-child{ border-bottom:0; }
    .switch{ display:flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .switch button{ background:transparent; color:var(--text); font-size:12px; font-weight:900; padding:10px 10px; }
    .switch button.active{ background:var(--btnSecondary); color:var(--btnSecondaryText); }
    .small{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="header">
        <img src="logo_round_256.png" class="logo" alt="Logo">
        <div>
          <h1>Gewichtsprüfung</h1>
          <div class="sub">Berechnung • Warnmodus • Theme • Speichern</div>
          <div class="status" id="jsStatus">JS lädt…</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Maximalgewicht (kg)</label>
          <input id="max" type="text" inputmode="decimal" placeholder="z.B. 3500,00">
        </div>
        <div>
          <label>Gemessenes Gewicht (kg)</label>
          <input id="measured" type="text" inputmode="decimal" placeholder="z.B. 3720,50">
        </div>
        <div>
          <label>Toleranzabzug (%)</label>
          <input id="tol" type="text" inputmode="decimal" value="3">
        </div>
        <div>
          <label>Überschreitungs-Grenze (%)</label>
          <input id="limit" type="text" inputmode="decimal" value="5">
        </div>
        <div style="grid-column:1/-1;">
          <label>Notiz (optional)</label>
          <textarea id="note" placeholder="z.B. Auftrag, Ort, …"></textarea>
        </div>
      </div>

      <div id="results"></div>

      <div class="tableWrap" style="margin-top:14px;">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th class="right">Max</th>
              <th class="right">Gemessen</th>
              <th class="right">Nach Tol.</th>
              <th class="right">Überladen %</th>
              <th>Status</th>
              <th>Notiz</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div class="small" style="margin-top:10px;">
        PDF: Druckansicht → Teilen → In Dateien sichern (PDF).
      </div>
    </div>
  </div>

  <div class="bottomBar">
    <div class="bottomInner">
      <div class="group">
        <button id="openSettings" class="secondary" type="button">Einstellungen</button>
        <button id="pdfBtn" class="secondary" type="button">PDF</button>
      </div>
      <div class="group">
        <button id="saveBtn" type="button">Speichern</button>
        <button id="resetBtn" class="secondary" type="button">Reset</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="settingsOverlay">
    <div class="modal">
      <div class="row">
        <div style="font-weight:900;">Einstellungen</div>
        <button id="closeSettings" class="secondary" type="button">Schließen</button>
      </div>

      <div class="optRow">
        <div>
          <div style="font-weight:900;">Theme</div>
          <div class="small">Auto / Hell / Dunkel</div>
        </div>
        <div class="switch">
          <button id="tAuto" type="button">AUTO</button>
          <button id="tLight" type="button">HELL</button>
          <button id="tDark" type="button">DUNKEL</button>
        </div>
      </div>

      <div class="optRow">
        <div>
          <div style="font-weight:900;">Warnmodus</div>
          <div class="small">Rote Warnfarbe bei Überschreitung</div>
        </div>
        <div class="switch">
          <button id="wOn" type="button">AN</button>
          <button id="wOff" type="button">AUS</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Elements
  var jsStatus = document.getElementById("jsStatus");
  jsStatus.textContent = "JS läuft ✅";

  var root = document.documentElement;
  var card = document.getElementById("card");
  var maxEl = document.getElementById("max");
  var measEl = document.getElementById("measured");
  var tolEl = document.getElementById("tol");
  var limEl = document.getElementById("limit");
  var noteEl = document.getElementById("note");
  var resultsEl = document.getElementById("results");
  var histBody = document.getElementById("historyBody");

  var openSettings = document.getElementById("openSettings");
  var closeSettings = document.getElementById("closeSettings");
  var overlay = document.getElementById("settingsOverlay");

  var saveBtn = document.getElementById("saveBtn");
  var resetBtn = document.getElementById("resetBtn");
  var pdfBtn = document.getElementById("pdfBtn");

  var tAuto = document.getElementById("tAuto");
  var tLight = document.getElementById("tLight");
  var tDark = document.getElementById("tDark");
  var wOn = document.getElementById("wOn");
  var wOff = document.getElementById("wOff");

  var THEME_KEY = "gewicht_theme_mode_fixed_v1";  // auto|light|dark
  var WARN_KEY  = "gewicht_warn_enabled_fixed_v1"; // 1|0
  var HIST_KEY  = "gewicht_history_fixed_v1";

  var warnEnabled = true;

  function parseNum(s){
    if (typeof s !== "string") return NaN;
    var n = Number(s.trim().replace(/\s+/g,"").replace(",","."));
    return Number.isFinite(n) ? n : NaN;
  }
  function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

  function nowStr(){
    var d = new Date();
    var p = function(n){ return String(n).padStart(2,"0"); };
    return p(d.getDate())+"."+p(d.getMonth()+1)+"."+d.getFullYear()+" "+p(d.getHours())+":"+p(d.getMinutes());
  }

  function setTheme(mode){
    root.setAttribute("data-theme", mode);
    localStorage.setItem(THEME_KEY, mode);
    tAuto.classList.toggle("active", mode==="auto");
    tLight.classList.toggle("active", mode==="light");
    tDark.classList.toggle("active", mode==="dark");
  }

  function setWarn(on){
    warnEnabled = !!on;
    localStorage.setItem(WARN_KEY, warnEnabled ? "1" : "0");
    wOn.classList.toggle("active", warnEnabled);
    wOff.classList.toggle("active", !warnEnabled);
    render();
  }

  // Init settings
  var savedTheme = localStorage.getItem(THEME_KEY) || "auto";
  setTheme(savedTheme);
  var savedWarn = localStorage.getItem(WARN_KEY);
  setWarn(savedWarn === null ? true : savedWarn === "1");

  // Modal
  openSettings.addEventListener("click", function(){ overlay.style.display="flex"; });
  closeSettings.addEventListener("click", function(){ overlay.style.display="none"; });
  overlay.addEventListener("click", function(e){ if (e.target === overlay) overlay.style.display="none"; });

  tAuto.addEventListener("click", function(){ setTheme("auto"); });
  tLight.addEventListener("click", function(){ setTheme("light"); });
  tDark.addEventListener("click", function(){ setTheme("dark"); });
  wOn.addEventListener("click", function(){ setWarn(true); });
  wOff.addEventListener("click", function(){ setWarn(false); });

  function calc(){
    var max = parseNum(maxEl.value);
    var meas = parseNum(measEl.value);
    var tol = parseNum(tolEl.value);
    var lim = parseNum(limEl.value);

    if (!Number.isFinite(max) || max<=0 || !Number.isFinite(meas) || !Number.isFinite(tol) || !Number.isFinite(lim)) return null;

    var afterTol = round2(meas * (1 - tol/100));
    var overloadKg = round2(Math.max(0, afterTol - max));
    var overloadPct = round2(Math.max(0, (afterTol - max) / max * 100));
    var devPct = round2(((afterTol - max) / max) * 100);
    var exceeded = afterTol > round2(max * (1 + lim/100));

    return { max:max, meas:meas, tol:tol, lim:lim, afterTol:afterTol, overloadKg:overloadKg, overloadPct:overloadPct, devPct:devPct, exceeded:exceeded };
  }

  function render(){
    var c = calc();
    if (!c){
      card.classList.remove("warn");
      resultsEl.innerHTML =
        '<div class="pill"><span>Nach Toleranz</span><strong>—</strong></div>' +
        '<div class="pill"><span>Übergewicht (kg)</span><strong>—</strong></div>' +
        '<div class="pill"><span>Überladen (%)</span><strong>—</strong></div>' +
        '<div class="pill"><span>Abweichung (%)</span><strong>—</strong></div>' +
        '<div class="pill"><span>Mehr als Grenze?</span><strong>—</strong></div>';
      return;
    }

    card.classList.toggle("warn", warnEnabled && c.exceeded);
    var statusCls = (warnEnabled && c.exceeded) ? "bad" : "ok";
    var statusTxt = c.exceeded ? "JA" : "NEIN";

    resultsEl.innerHTML =
      '<div class="pill"><span>Nach Toleranz</span><strong>' + c.afterTol.toFixed(2) + ' kg</strong></div>' +
      '<div class="pill"><span>Übergewicht (kg)</span><strong>' + c.overloadKg.toFixed(2) + ' kg</strong></div>' +
      '<div class="pill"><span>Überladen (%)</span><strong>' + c.overloadPct.toFixed(2) + ' %</strong></div>' +
      '<div class="pill"><span>Abweichung (%)</span><strong>' + c.devPct.toFixed(2) + ' %</strong></div>' +
      '<div class="pill ' + statusCls + '"><span>Mehr als ' + c.lim.toFixed(2) + '% über Max?</span><strong>' + statusTxt + '</strong></div>';
  }

  function loadHist(){
    try{
      var raw = localStorage.getItem(HIST_KEY);
      var arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveHist(arr){
    localStorage.setItem(HIST_KEY, JSON.stringify(arr));
  }
  function renderHist(){
    var arr = loadHist();
    if (arr.length === 0){
      histBody.innerHTML = '<tr><td colspan="7" style="color:var(--muted);">Noch keine Einträge.</td></tr>';
      return;
    }
    histBody.innerHTML = arr.map(function(e){
      var st = e.exceeded ? "Überschritten" : "OK";
      return '<tr>' +
        '<td>' + e.date + '</td>' +
        '<td class="right">' + Number(e.max).toFixed(2) + '</td>' +
        '<td class="right">' + Number(e.meas).toFixed(2) + '</td>' +
        '<td class="right">' + Number(e.afterTol).toFixed(2) + '</td>' +
        '<td class="right">' + Number(e.overloadPct).toFixed(2) + ' %</td>' +
        '<td>' + st + '</td>' +
        '<td>' + (e.note||"") + '</td>' +
      '</tr>';
    }).join("");
  }

  saveBtn.addEventListener("click", function(){
    var c = calc();
    if (!c){ alert("Bitte Werte eingeben."); return; }
    var arr = loadHist();
    arr.unshift({
      date: nowStr(),
      max: c.max, meas: c.meas, afterTol: c.afterTol, overloadPct: c.overloadPct, exceeded: c.exceeded,
      note: (noteEl.value || "").trim()
    });
    saveHist(arr);
    noteEl.value = "";
    renderHist();
  });

  resetBtn.addEventListener("click", function(){
    maxEl.value = ""; measEl.value = ""; tolEl.value = "3"; limEl.value = "5"; noteEl.value = "";
    render();
  });

  pdfBtn.addEventListener("click", function(){
    // PDF über Print (iPhone: Teilen -> In Dateien sichern)
    window.print();
  });

  [maxEl, measEl, tolEl, limEl].forEach(function(el){ el.addEventListener("input", render); });

  render();
  renderHist();

  // Service Worker (optional)
  if ("serviceWorker" in navigator){
    window.addEventListener("load", function(){
      navigator.serviceWorker.register("./sw.js").catch(function(){});
    });
  }
})();
</script>
</body>
</html>
