<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gewichtsprüfung</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Gewicht">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#111111">

  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">

  <style>
    /* ------------------ Theme Vars ------------------ */
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111111;
      --muted: #666666;
      --border: #e3e6f2;

      --pill: #f2f4ff;
      --ok: #e9fbf0;
      --bad: #ffecec;

      --btn: #111111;
      --btnText: #ffffff;
      --btnSecondary: #eef0f8;
      --btnSecondaryText: #111111;

      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --focus: 0 0 0 3px rgba(107,124,255,.15);
      --focusBorder: #6b7cff;

      --warnBorder: rgba(198,40,40,.45);
      --warnGlow: 0 0 0 4px rgba(198,40,40,.10);
    }

    /* Auto dark (only if user chooses AUTO) */
    @media (prefers-color-scheme: dark){
      :root[data-theme="auto"]{
        --bg: #0b0d12;
        --card: #121521;
        --text: #f2f3f5;
        --muted: #a8b0c0;
        --border: #232a3b;

        --pill: #171c2a;
        --ok: rgba(46,204,113,.15);
        --bad: rgba(231,76,60,.18);

        --btn: #f2f3f5;
        --btnText: #111111;
        --btnSecondary: #1b2133;
        --btnSecondaryText: #f2f3f5;

        --shadow: 0 10px 30px rgba(0,0,0,.45);
        --focus: 0 0 0 3px rgba(107,124,255,.25);
        --focusBorder: #8b97ff;

        --warnBorder: rgba(255,90,90,.55);
        --warnGlow: 0 0 0 4px rgba(255,90,90,.12);
      }
    }

    /* Forced dark */
    :root[data-theme="dark"]{
      --bg: #0b0d12;
      --card: #121521;
      --text: #f2f3f5;
      --muted: #a8b0c0;
      --border: #232a3b;

      --pill: #171c2a;
      --ok: rgba(46,204,113,.15);
      --bad: rgba(231,76,60,.18);

      --btn: #f2f3f5;
      --btnText: #111111;
      --btnSecondary: #1b2133;
      --btnSecondaryText: #f2f3f5;

      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --focus: 0 0 0 3px rgba(107,124,255,.25);
      --focusBorder: #8b97ff;

      --warnBorder: rgba(255,90,90,.55);
      --warnGlow: 0 0 0 4px rgba(255,90,90,.12);
    }

    /* Forced light */
    :root[data-theme="light"]{ /* uses defaults */ }

    /* ------------------ Layout ------------------ */
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; padding-bottom: 36px; }
    .card { background:var(--card); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); border: 1px solid transparent; }

    .card.warn{
      border-color: var(--warnBorder);
      box-shadow: var(--shadow), var(--warnGlow);
    }

    .header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top: 6px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }

    .appLogo{
      display:block;
      width: 84px;
      height: auto;
      flex: 0 0 auto;
    }

    .titles{ min-width:0; }
    h1 { font-size: 18px; margin: 0; }
    .sub { font-size: 12px; color:var(--muted); margin: 2px 0 0; }

    .topActions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .seg{
      display:flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
      background: transparent;
    }
    .seg button{
      padding: 10px 10px;
      border:0;
      background: transparent;
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
    }
    .seg button.active{
      background: var(--btnSecondary);
      color: var(--btnSecondaryText);
    }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px; }
    @media (max-width: 820px){ .grid { grid-template-columns: 1fr; } }

    label { display:block; font-size: 12px; color:var(--muted); margin-bottom: 6px; }
    input, textarea {
      width:100%; padding: 12px 12px; font-size: 16px;
      border:1px solid var(--border); border-radius: 12px; outline:none;
      background:var(--card); color:var(--text);
    }
    input:focus, textarea:focus { border-color: var(--focusBorder); box-shadow: var(--focus); }
    textarea { min-height: 44px; resize: vertical; }

    .muted { color:var(--muted); font-size: 12px; margin-top: 6px; line-height: 1.25; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }

    button{
      cursor:pointer; border:0; padding: 12px 14px; border-radius: 12px;
      background:var(--btn); color:var(--btnText); font-weight: 900; font-size: 15px;
    }
    button.secondary { background:var(--btnSecondary); color:var(--btnSecondaryText); }
    button.danger { background:#c62828; color:#fff; }
    button:active { transform: translateY(1px); }

    .results { margin-top: 14px; display:grid; gap:10px; }
    .pill{
      display:flex; justify-content:space-between; gap:12px;
      padding: 12px; border-radius: 14px; background:var(--pill);
    }
    .pill strong { font-weight: 1000; }
    .ok { background:var(--ok); }
    .bad { background:var(--bad); }

    .toolbar { margin-top: 12px; display:flex; gap:12px; flex-wrap: wrap; align-items:center; }

    .tableWrap { margin-top: 12px; overflow:auto; border:1px solid var(--border); border-radius: 12px; }
    table { width:100%; border-collapse: collapse; min-width: 980px; }
    th, td { padding: 10px 10px; border-bottom: 1px solid rgba(227,230,242,.45); font-size: 13px; text-align:left; vertical-align: top; }
    :root[data-theme="dark"] th, :root[data-theme="dark"] td { border-bottom: 1px solid rgba(35,42,59,.85); }
    :root[data-theme="auto"] th, :root[data-theme="auto"] td { } /* handled by vars */
    th { font-size: 12px; color:var(--muted); background: rgba(250,251,255,.6); position: sticky; top: 0; }
    :root[data-theme="dark"] th { background: rgba(27,33,51,.75); }
    tr:last-child td { border-bottom: 0; }
    .right { text-align:right; }

    .chip { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 1000; }
    .chip.ok { background:var(--ok); }
    .chip.bad { background:var(--bad); }

    .thumb{
      width: 54px;
      height: 54px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .offlineBar{
      display:none;
      margin: 12px 0 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 193, 7, .15);
      border: 1px solid rgba(255, 193, 7, .35);
      color: var(--text);
      font-size: 13px;
    }

    /* Print/PDF styling */
    @media print {
      body { background:#fff; color:#000; }
      .wrap { padding:0; }
      .card { box-shadow:none; border:0; }
      .topActions, .toolbar, .tableWrap, .offlineBar { display:none !important; }
      .grid { grid-template-columns: 1fr 1fr; }
      button { display:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card">

      <div class="header">
        <div class="brand">
          <img src="logo_round_256.png" alt="Logo" class="appLogo">
          <div class="titles">
            <h1>Gewichtsprüfung</h1>
            <div class="sub">Offline • Dark Mode • PDF • Foto • Zeit/Ort • Warnfarbe</div>
          </div>
        </div>

        <div class="topActions">
          <div class="seg" aria-label="Theme">
            <button id="themeAuto" type="button">AUTO</button>
            <button id="themeLight" type="button">HELL</button>
            <button id="themeDark" type="button">DUNKEL</button>
          </div>
          <button id="pdfCurrent" type="button" class="secondary">PDF (aktuell)</button>
        </div>
      </div>

      <div class="offlineBar" id="offlineBar">⚠️ Offline-Modus aktiv (kein Internet). App funktioniert weiterhin.</div>

      <div class="grid">
        <div>
          <label for="max">Maximalgewicht (kg)</label>
          <input id="max" type="text" inputmode="decimal" placeholder="z.B. 3500,00" autocomplete="off" />
        </div>

        <div>
          <label for="measured">Gemessenes Gewicht (kg)</label>
          <input id="measured" type="text" inputmode="decimal" placeholder="z.B. 3720,50" autocomplete="off" />
        </div>

        <div>
          <label for="tol">Toleranzabzug (%)</label>
          <input id="tol" type="text" inputmode="decimal" value="3" autocomplete="off" />
          <div class="muted">Wird vom gemessenen Gewicht abgezogen</div>
        </div>

        <div>
          <label for="limit">Überschreitungs-Grenze (%)</label>
          <input id="limit" type="text" inputmode="decimal" value="5" autocomplete="off" />
          <div class="muted">„JA“, wenn (nach Toleranz) &gt; Max × (1 + Grenze)</div>
        </div>

        <div style="grid-column:1/-1;">
          <label for="photo">Foto (optional)</label>
          <input id="photo" type="file" accept="image/*" capture="environment">
          <div class="row" style="margin-top:10px;">
            <img id="photoPreview" class="thumb" alt="Vorschau" style="display:none;">
            <button id="clearPhoto" type="button" class="secondary" style="display:none;">Foto entfernen</button>
            <span class="muted" id="photoHint">Tipp: Kamera öffnet sich direkt (iPhone).</span>
          </div>
        </div>

        <div style="grid-column:1/-1;">
          <label for="note">Notiz (optional)</label>
          <textarea id="note" placeholder="z.B. Auftrag, Ort, Waage, …"></textarea>
        </div>

        <div class="row" style="grid-column:1/-1;">
          <button id="save" type="button">Messung speichern</button>
          <button id="reset" type="button" class="secondary">Zurücksetzen</button>
          <button id="pdfLast" type="button" class="secondary">PDF (letzte Messung)</button>
          <span class="muted">Eingaben ändern → Ergebnis aktualisiert automatisch.</span>
        </div>
      </div>

      <div class="results" id="results"></div>

      <div class="toolbar">
        <button id="exportCsv" type="button" class="secondary">Export CSV</button>
        <button id="clearAll" type="button" class="danger">Alles löschen</button>
        <span class="muted">Fotos & Daten werden lokal auf deinem Gerät gespeichert.</span>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Ort</th>
              <th class="right">Max</th>
              <th class="right">Gemessen</th>
              <th class="right">Nach Tol.</th>
              <th class="right">Übergewicht</th>
              <th class="right">Überladen</th>
              <th class="right">Abw.</th>
              <th>Status</th>
              <th>Foto</th>
              <th>Notiz</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:12px; line-height:1.35;">
        PDF Hinweis (iPhone): Beim PDF-Export öffnet sich die Druckansicht → „Teilen“ → „In Dateien sichern“ = PDF speichern.
      </div>

    </div>
  </div>

<script>
  // ---------- Elements ----------
  const root = document.documentElement;
  const card = document.getElementById("card");

  const elMax = document.getElementById("max");
  const elMeasured = document.getElementById("measured");
  const elTol = document.getElementById("tol");
  const elLimit = document.getElementById("limit");
  const elNote = document.getElementById("note");

  const elPhoto = document.getElementById("photo");
  const elPhotoPreview = document.getElementById("photoPreview");
  const btnClearPhoto = document.getElementById("clearPhoto");

  const results = document.getElementById("results");
  const historyBody = document.getElementById("historyBody");

  const saveBtn = document.getElementById("save");
  const resetBtn = document.getElementById("reset");
  const exportBtn = document.getElementById("exportCsv");
  const clearAllBtn = document.getElementById("clearAll");

  const offlineBar = document.getElementById("offlineBar");

  const btnPdfCurrent = document.getElementById("pdfCurrent");
  const btnPdfLast = document.getElementById("pdfLast");

  const btnThemeAuto = document.getElementById("themeAuto");
  const btnThemeLight = document.getElementById("themeLight");
  const btnThemeDark = document.getElementById("themeDark");

  // ---------- Storage keys ----------
  const STORAGE_KEY = "gewicht_app_history_v5";
  const THEME_KEY = "gewicht_theme_mode_v1"; // auto|light|dark

  // ---------- Helpers ----------
  function parseNum(s) {
    if (typeof s !== "string") return NaN;
    const normalized = s.trim().replace(/\\s+/g, "").replace(",", ".");
    const v = Number(normalized);
    return Number.isFinite(v) ? v : NaN;
  }
  const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
  const roundPct2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;

  function nowLocalString() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function fmtCoord(lat, lon) {
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return "—";
    return `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  }

  // ---------- Theme (manual toggle) ----------
  function setTheme(mode){
    root.setAttribute("data-theme", mode);
    localStorage.setItem(THEME_KEY, mode);

    btnThemeAuto.classList.toggle("active", mode === "auto");
    btnThemeLight.classList.toggle("active", mode === "light");
    btnThemeDark.classList.toggle("active", mode === "dark");
  }

  (function initTheme(){
    const saved = localStorage.getItem(THEME_KEY) || "auto";
    setTheme(saved);
  })();

  btnThemeAuto.addEventListener("click", () => setTheme("auto"));
  btnThemeLight.addEventListener("click", () => setTheme("light"));
  btnThemeDark.addEventListener("click", () => setTheme("dark"));

  // ---------- Photo handling (compress & preview) ----------
  let currentPhotoDataUrl = null; // JPEG dataURL
  async function fileToCompressedDataURL(file){
    // Downscale to max 1280px, JPEG q=0.75
    const bitmap = await createImageBitmap(file);
    const maxSide = 1280;
    let { width, height } = bitmap;
    const scale = Math.min(1, maxSide / Math.max(width, height));
    width = Math.round(width * scale);
    height = Math.round(height * scale);

    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0, width, height);

    return canvas.toDataURL("image/jpeg", 0.75);
  }

  elPhoto.addEventListener("change", async () => {
    const f = elPhoto.files && elPhoto.files[0];
    if (!f) return;
    try{
      currentPhotoDataUrl = await fileToCompressedDataURL(f);
      elPhotoPreview.src = currentPhotoDataUrl;
      elPhotoPreview.style.display = "block";
      btnClearPhoto.style.display = "inline-block";
    }catch{
      alert("Foto konnte nicht verarbeitet werden.");
      currentPhotoDataUrl = null;
      elPhoto.value = "";
    }
  });

  btnClearPhoto.addEventListener("click", () => {
    currentPhotoDataUrl = null;
    elPhoto.value = "";
    elPhotoPreview.src = "";
    elPhotoPreview.style.display = "none";
    btnClearPhoto.style.display = "none";
  });

  // ---------- Calculation ----------
  function calc() {
    const max = parseNum(elMax.value);
    const measured = parseNum(elMeasured.value);
    const tolPct = parseNum(elTol.value) / 100;
    const limitPct = parseNum(elLimit.value) / 100;

    const ok =
      Number.isFinite(max) && max > 0 &&
      Number.isFinite(measured) &&
      Number.isFinite(tolPct) &&
      Number.isFinite(limitPct);

    if (!ok) return { ok:false };

    const afterTol = round2(measured * (1 - tolPct));
    const overweightKg = round2(Math.max(0, afterTol - max));
    const overloadPercent = roundPct2(Math.max(0, (afterTol - max) / max * 100));
    const deviationPercent = roundPct2(((afterTol - max) / max) * 100);

    const threshold = round2(max * (1 + limitPct));
    const exceeded = afterTol > threshold;

    return {
      ok:true,
      max: round2(max),
      measured: round2(measured),
      tolPct,
      limitPct,
      afterTol,
      overweightKg,
      overloadPercent,
      deviationPercent,
      exceeded
    };
  }

  function render() {
    const c = calc();
    if (!c.ok) {
      card.classList.remove("warn");
      results.innerHTML = `
        <div class="pill"><span>Gemessen nach Toleranzabzug</span><strong>—</strong></div>
        <div class="pill"><span>Übergewicht (kg)</span><strong>—</strong></div>
        <div class="pill"><span>Überladen (%)</span><strong>—</strong></div>
        <div class="pill"><span>Abweichung zum Maximum (%)</span><strong>—</strong></div>
        <div class="pill"><span>Mehr als Grenze über Max?</span><strong>—</strong></div>
      `;
      return;
    }

    card.classList.toggle("warn", c.exceeded);
    const statusClass = c.exceeded ? "bad" : "ok";
    const statusText = c.exceeded ? "JA" : "NEIN";

    results.innerHTML = `
      <div class="pill">
        <span>Gemessen nach Toleranzabzug</span>
        <strong>${c.afterTol.toFixed(2)} kg</strong>
      </div>
      <div class="pill">
        <span>Übergewicht (kg)</span>
        <strong>${c.overweightKg.toFixed(2)} kg</strong>
      </div>
      <div class="pill">
        <span>Überladen (%)</span>
        <strong>${c.overloadPercent.toFixed(2)} %</strong>
      </div>
      <div class="pill">
        <span>Abweichung zum Maximum (%)</span>
        <strong>${c.deviationPercent.toFixed(2)} %</strong>
      </div>
      <div class="pill ${statusClass}">
        <span>Mehr als ${(c.limitPct*100).toFixed(2)} % über Max?</span>
        <strong>${statusText}</strong>
      </div>
    `;
  }

  // ---------- History ----------
  function loadHistory() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function saveHistory(arr) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }

  function renderHistory() {
    const arr = loadHistory();
    if (arr.length === 0) {
      historyBody.innerHTML = `<tr><td colspan="12" class="muted">Noch keine gespeicherten Messungen.</td></tr>`;
      return;
    }

    historyBody.innerHTML = arr.map((e, idx) => {
      const chipClass = e.exceeded ? "chip bad" : "chip ok";
      const chipText = e.exceeded ? "Überschritten" : "OK";
      const safeNote = (e.note || "").replaceAll("<","&lt;").replaceAll(">","&gt;");
      const loc = e.location && Number.isFinite(e.location.lat) ? fmtCoord(e.location.lat, e.location.lon) : "—";
      const thumb = e.photoDataUrl ? `<img class="thumb" src="${e.photoDataUrl}" alt="Foto">` : "—";

      return `
        <tr>
          <td>${e.date}</td>
          <td>${loc}</td>
          <td class="right">${Number(e.max).toFixed(2)}</td>
          <td class="right">${Number(e.measured).toFixed(2)}</td>
          <td class="right">${Number(e.afterTol).toFixed(2)}</td>
          <td class="right">${Number(e.overweightKg).toFixed(2)}</td>
          <td class="right">${Number(e.overloadPercent).toFixed(2)} %</td>
          <td class="right">${Number(e.deviationPercent).toFixed(2)} %</td>
          <td><span class="${chipClass}">${chipText}</span></td>
          <td>${thumb}</td>
          <td>${safeNote}</td>
          <td class="right">
            <button class="secondary" data-pdf="${idx}" type="button">PDF</button>
            <button class="secondary" data-del="${idx}" type="button">Löschen</button>
          </td>
        </tr>
      `;
    }).join("");

    historyBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        const arr2 = loadHistory();
        arr2.splice(i, 1);
        saveHistory(arr2);
        renderHistory();
      });
    });

    historyBody.querySelectorAll("button[data-pdf]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-pdf"));
        const arr2 = loadHistory();
        const entry = arr2[i];
        if (entry) openPrintView(entry);
      });
    });
  }

  // ---------- Location ----------
  function getLocationOnce(timeoutMs = 6000){
    return new Promise((resolve) => {
      if (!("geolocation" in navigator)) return resolve(null);

      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        () => resolve(null),
        { enableHighAccuracy: true, timeout: timeoutMs, maximumAge: 60000 }
      );
    });
  }

  // ---------- Save ----------
  async function onSave() {
    const c = calc();
    if (!c.ok) {
      alert("Bitte gültige Zahlen eingeben (Max > 0, gemessen, Toleranz, Grenze).");
      return;
    }

    // Location stamp (optional - permission request may appear)
    const loc = await getLocationOnce();

    const entry = {
      date: nowLocalString(),
      max: c.max,
      measured: c.measured,
      tolPercent: roundPct2(c.tolPct * 100),
      limitPercent: roundPct2(c.limitPct * 100),
      afterTol: c.afterTol,
      overweightKg: c.overweightKg,
      overloadPercent: c.overloadPercent,
      deviationPercent: c.deviationPercent,
      exceeded: c.exceeded,
      note: elNote.value.trim(),
      photoDataUrl: currentPhotoDataUrl,     // can be null
      location: loc                           // can be null
    };

    const arr = loadHistory();
    arr.unshift(entry);
    saveHistory(arr);
    renderHistory();

    // keep inputs, clear note+photo if desired
    elNote.value = "";
    // keep photo if you want; here we clear for next measurement:
    btnClearPhoto.click();

    // Warning vibration (optional; may be blocked on iOS)
    if (entry.exceeded && navigator.vibrate) {
      try { navigator.vibrate([80, 80, 80]); } catch {}
    }
  }

  function onReset() {
    elMax.value = "";
    elMeasured.value = "";
    elTol.value = "3";
    elLimit.value = "5";
    elNote.value = "";
    btnClearPhoto.click();
    render();
  }

  // ---------- CSV Export ----------
  function exportCSV() {
    const arr = loadHistory();
    if (arr.length === 0) { alert("Keine Daten zum Exportieren."); return; }

    const header = [
      "Datum","Ort","Genauigkeit_m",
      "Max_kg","Gemessen_kg","Toleranz_%","Grenze_%",
      "NachTol_kg","Übergewicht_kg","Überladen_%","Abweichung_%","Überschritten","Notiz"
    ];

    const rows = arr.map(e => [
      e.date,
      e.location ? `${e.location.lat.toFixed(5)} ${e.location.lon.toFixed(5)}` : "",
      e.location && Number.isFinite(e.location.acc) ? e.location.acc.toFixed(0) : "",
      Number(e.max).toFixed(2),
      Number(e.measured).toFixed(2),
      Number(e.tolPercent).toFixed(2),
      Number(e.limitPercent).toFixed(2),
      Number(e.afterTol).toFixed(2),
      Number(e.overweightKg).toFixed(2),
      Number(e.overloadPercent).toFixed(2),
      Number(e.deviationPercent).toFixed(2),
      e.exceeded ? "JA" : "NEIN",
      (e.note || "").replaceAll('"','""')
    ]);

    const csv = [header.join(","), ...rows.map(r => r.map(v => {
      const s = String(v);
      return /[",\\n]/.test(s) ? `"${s}"` : s;
    }).join(","))].join("\\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gewicht-messungen.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearAll() {
    if (!confirm("Wirklich alle gespeicherten Messungen löschen?")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }

  // ---------- Offline banner ----------
  function updateOfflineBanner() {
    offlineBar.style.display = navigator.onLine ? "none" : "block";
  }
  window.addEventListener("online", updateOfflineBanner);
  window.addEventListener("offline", updateOfflineBanner);

  // ---------- PDF export (Print view) ----------
  function openPrintView(entry){
    // Create a printable HTML doc and open print dialog.
    // iPhone: Share -> Save to Files (PDF).
    const locText = entry.location ? `${entry.location.lat.toFixed(5)}, ${entry.location.lon.toFixed(5)} (±${Math.round(entry.location.acc)} m)` : "—";

    const status = entry.exceeded ? "ÜBERSCHRITTEN" : "OK";
    const statusColor = entry.exceeded ? "#c62828" : "#2e7d32";

    const imgHtml = entry.photoDataUrl
      ? `<img src="${entry.photoDataUrl}" style="width:100%;max-width:520px;border-radius:14px;border:1px solid #ddd;" />`
      : `<div style="color:#666">Kein Foto</div>`;

    const html = `
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messprotokoll</title>
<style>
  body{ font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:24px; color:#111; }
  .head{ display:flex; align-items:center; gap:14px; margin-bottom:16px; }
  .logo{ width:72px; height:auto; }
  h1{ font-size:18px; margin:0; }
  .muted{ color:#666; font-size:12px; margin-top:2px; }
  .box{ border:1px solid #e6e6e6; border-radius:14px; padding:14px; margin-top:12px; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .row{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed #eee; }
  .row:last-child{ border-bottom:0; }
  .k{ color:#444; }
  .v{ font-weight:700; }
  .status{ display:inline-block; padding:6px 10px; border-radius:999px; color:#fff; font-weight:800; background:${statusColor}; }
  @media print { body{ margin:0; } }
</style>
</head>
<body>
  <div class="head">
    <img src="logo_round_256.png" class="logo" alt="Logo">
    <div>
      <h1>Messprotokoll – Gewichtsprüfung</h1>
      <div class="muted">Datum/Zeit: ${entry.date} • Ort: ${locText}</div>
    </div>
  </div>

  <div class="box">
    <div class="row"><span class="k">Status</span><span class="status">${status}</span></div>
    <div class="grid" style="margin-top:10px;">
      <div class="box" style="margin:0;">
        <div class="row"><span class="k">Maximalgewicht</span><span class="v">${Number(entry.max).toFixed(2)} kg</span></div>
        <div class="row"><span class="k">Gemessen</span><span class="v">${Number(entry.measured).toFixed(2)} kg</span></div>
        <div class="row"><span class="k">Toleranz</span><span class="v">${Number(entry.tolPercent).toFixed(2)} %</span></div>
        <div class="row"><span class="k">Grenze</span><span class="v">${Number(entry.limitPercent).toFixed(2)} %</span></div>
      </div>

      <div class="box" style="margin:0;">
        <div class="row"><span class="k">Nach Toleranz</span><span class="v">${Number(entry.afterTol).toFixed(2)} kg</span></div>
        <div class="row"><span class="k">Übergewicht</span><span class="v">${Number(entry.overweightKg).toFixed(2)} kg</span></div>
        <div class="row"><span class="k">Überladen</span><span class="v">${Number(entry.overloadPercent).toFixed(2)} %</span></div>
        <div class="row"><span class="k">Abweichung</span><span class="v">${Number(entry.deviationPercent).toFixed(2)} %</span></div>
      </div>
    </div>

    <div class="box">
      <div class="muted" style="margin-bottom:8px;">Foto</div>
      ${imgHtml}
    </div>

    <div class="box">
      <div class="muted" style="margin-bottom:6px;">Notiz</div>
      <div>${(entry.note || "—").replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
    </div>
  </div>

  <script>
    // Open print dialog automatically
    setTimeout(() => { window.print(); }, 300);
  </script>
</body>
</html>`;

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  btnPdfCurrent.addEventListener("click", () => {
    const c = calc();
    if (!c.ok) { alert("Bitte zuerst gültige Werte eingeben."); return; }
    // Create a temp entry from current inputs (no GPS/photo unless present)
    const entry = {
      date: nowLocalString(),
      max: c.max,
      measured: c.measured,
      tolPercent: roundPct2(c.tolPct * 100),
      limitPercent: roundPct2(c.limitPct * 100),
      afterTol: c.afterTol,
      overweightKg: c.overweightKg,
      overloadPercent: c.overloadPercent,
      deviationPercent: c.deviationPercent,
      exceeded: c.exceeded,
      note: elNote.value.trim(),
      photoDataUrl: currentPhotoDataUrl,
      location: null
    };
    openPrintView(entry);
  });

  btnPdfLast.addEventListener("click", () => {
    const arr = loadHistory();
    if (arr.length === 0) { alert("Noch keine gespeicherte Messung vorhanden."); return; }
    openPrintView(arr[0]);
  });

  // ---------- Events ----------
  [elMax, elMeasured, elTol, elLimit].forEach(el => el.addEventListener("input", render));
  saveBtn.addEventListener("click", onSave);
  resetBtn.addEventListener("click", onReset);
  exportBtn.addEventListener("click", exportCSV);
  clearAllBtn.addEventListener("click", clearAll);

  // ---------- Init ----------
  render();
  renderHistory();
  updateOfflineBanner();

  // ---------- Offline (Service Worker) ----------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
</script>
</body>
</html>
