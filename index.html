<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gewichtsprüfung</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Gewicht">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#111111">

  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --border:#e3e6f2;
      --pill:#f2f4ff; --ok:#e9fbf0; --bad:#ffecec;
      --btn:#111; --btnText:#fff; --btnSecondary:#eef0f8; --btnSecondaryText:#111;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --focus:0 0 0 3px rgba(107,124,255,.15); --focusBorder:#6b7cff;
      --warnBorder:rgba(198,40,40,.45); --warnGlow:0 0 0 4px rgba(198,40,40,.10);
      --modalBg: rgba(0,0,0,.35);
      --link: #2a5bd7;
      --barBg: rgba(255,255,255,.92);
    }

    @media (prefers-color-scheme: dark){
      :root[data-theme="auto"]{
        --bg:#0b0d12; --card:#121521; --text:#f2f3f5; --muted:#a8b0c0; --border:#232a3b;
        --pill:#171c2a; --ok:rgba(46,204,113,.15); --bad:rgba(231,76,60,.18);
        --btn:#f2f3f5; --btnText:#111; --btnSecondary:#1b2133; --btnSecondaryText:#f2f3f5;
        --shadow:0 10px 30px rgba(0,0,0,.45);
        --focus:0 0 0 3px rgba(107,124,255,.25); --focusBorder:#8b97ff;
        --warnBorder:rgba(255,90,90,.55); --warnGlow:0 0 0 4px rgba(255,90,90,.12);
        --modalBg: rgba(0,0,0,.55);
        --link: #86a8ff;
        --barBg: rgba(18,21,33,.92);
      }
    }
    :root[data-theme="dark"]{
      --bg:#0b0d12; --card:#121521; --text:#f2f3f5; --muted:#a8b0c0; --border:#232a3b;
      --pill:#171c2a; --ok:rgba(46,204,113,.15); --bad:rgba(231,76,60,.18);
      --btn:#f2f3f5; --btnText:#111; --btnSecondary:#1b2133; --btnSecondaryText:#f2f3f5;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --focus:0 0 0 3px rgba(107,124,255,.25); --focusBorder:#8b97ff;
      --warnBorder:rgba(255,90,90,.55); --warnGlow:0 0 0 4px rgba(255,90,90,.12);
      --modalBg: rgba(0,0,0,.55);
      --link: #86a8ff;
      --barBg: rgba(18,21,33,.92);
    }

    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    a { color: var(--link); text-decoration: none; }

    /* iOS touch reliability */
    button, a { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    .wrap { max-width: 1020px; margin:0 auto; padding:18px; padding-bottom: 128px; }
    .card { background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--shadow); border:1px solid transparent; }
    .card.warn{ border-color: var(--warnBorder); box-shadow: var(--shadow), var(--warnGlow); }

    .header{ display:flex; align-items:center; gap:10px; margin-top:6px; }
    .appLogo{ width:80px; height:auto; flex:0 0 auto; display:block; }
    h1{ margin:0; font-size:18px; }
    .sub{ margin:2px 0 0; font-size:12px; color:var(--muted); }
    .statusPill{
      display:inline-block;
      margin-top:6px;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(46,204,113,.18);
      border:1px solid rgba(46,204,113,.35);
      color: var(--text);
    }

    .offlineBar{
      display:none; margin:12px 0 0; padding:10px 12px; border-radius:12px;
      background: rgba(255, 193, 7, .15);
      border: 1px solid rgba(255, 193, 7, .35);
      color: var(--text); font-size: 13px;
    }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px; }
    @media (max-width: 820px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, textarea{
      width:100%; padding:12px 12px; font-size:16px;
      border:1px solid var(--border); border-radius:12px; outline:none;
      background:var(--card); color:var(--text);
    }
    input:focus, textarea:focus{ border-color:var(--focusBorder); box-shadow:var(--focus); }
    textarea{ min-height:44px; resize:vertical; }

    .muted{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.25; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    button{
      cursor:pointer; border:0; padding:12px 14px; border-radius:12px;
      background:var(--btn); color:var(--btnText); font-weight:900; font-size:15px;
    }
    button.secondary{ background:var(--btnSecondary); color:var(--btnSecondaryText); }
    button.danger{ background:#c62828; color:#fff; }

    .results{ margin-top:14px; display:grid; gap:10px; }
    .pill{ display:flex; justify-content:space-between; gap:12px; padding:12px; border-radius:14px; background:var(--pill); }
    .pill strong{ font-weight:1000; }
    .ok{ background:var(--ok); }
    .bad{ background:var(--bad); }

    .toolbar{ margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    .tableWrap{ margin-top:12px; overflow:auto; border:1px solid var(--border); border-radius:12px; }
    table{ width:100%; border-collapse:collapse; min-width: 1060px; }
    th, td{ padding:10px 10px; border-bottom:1px solid rgba(227,230,242,.45); font-size:13px; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); background: rgba(250,251,255,.6); position: sticky; top:0; }
    tr:last-child td{ border-bottom:0; }
    .right{ text-align:right; }
    .chip{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:1000; }
    .chip.ok{ background:var(--ok); }
    .chip.bad{ background:var(--bad); }
    .thumb{ width:54px; height:54px; border-radius:12px; object-fit:cover; border:1px solid var(--border); }

    /* Bottom bar fixed */
    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: var(--barBg);
      border-top: 1px solid var(--border);
      z-index: 9998;
      pointer-events: auto;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    .bottomInner{
      max-width: 1020px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .bottomInner .left, .bottomInner .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    /* Settings modal */
    .modalOverlay{
      display:none;
      position: fixed; inset: 0;
      background: var(--modalBg);
      padding: 18px;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal{
      width: min(520px, 100%);
      background: var(--card);
      color: var(--text);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .optRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px solid rgba(227,230,242,.45); }
    .optRow:last-child{ border-bottom:0; }
    .small{ font-size:12px; color: var(--muted); margin-top:4px; }
    .switch{
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .switch button{
      padding:10px 10px;
      border:0;
      background:transparent;
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
    }
    .switch button.active{
      background: var(--btnSecondary);
      color: var(--btnSecondaryText);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card">

      <div class="header">
        <img src="logo_round_256.png" alt="Logo" class="appLogo">
        <div>
          <h1>Gewichtsprüfung</h1>
          <div class="sub">Buttons unten • Offline • Einstellungen • Maps-Link • Foto • PDF</div>
          <div class="statusPill" id="jsStatus">JS lädt…</div>
        </div>
      </div>

      <div class="offlineBar" id="offlineBar">⚠️ Offline-Modus aktiv (kein Internet). App funktioniert weiterhin.</div>

      <div class="grid">
        <div>
          <label for="max">Maximalgewicht (kg)</label>
          <input id="max" type="text" inputmode="decimal" placeholder="z.B. 3500,00" autocomplete="off" />
        </div>

        <div>
          <label for="measured">Gemessenes Gewicht (kg)</label>
          <input id="measured" type="text" inputmode="decimal" placeholder="z.B. 3720,50" autocomplete="off" />
        </div>

        <div>
          <label for="tol">Toleranzabzug (%)</label>
          <input id="tol" type="text" inputmode="decimal" value="3" autocomplete="off" />
          <div class="muted">Wird vom gemessenen Gewicht abgezogen</div>
        </div>

        <div>
          <label for="limit">Überschreitungs-Grenze (%)</label>
          <input id="limit" type="text" inputmode="decimal" value="5" autocomplete="off" />
          <div class="muted">„JA“, wenn (nach Toleranz) &gt; Max × (1 + Grenze)</div>
        </div>

        <div style="grid-column:1/-1;">
          <label for="photo">Foto (optional)</label>
          <input id="photo" type="file" accept="image/*" capture="environment">
          <div class="row" style="margin-top:10px;">
            <img id="photoPreview" class="thumb" alt="Vorschau" style="display:none;">
            <button id="clearPhoto" type="button" class="secondary" style="display:none;">Foto entfernen</button>
            <span class="muted">Tipp: Kamera öffnet sich direkt (iPhone).</span>
          </div>
        </div>

        <div style="grid-column:1/-1;">
          <label for="note">Notiz (optional)</label>
          <textarea id="note" placeholder="z.B. Auftrag, Ort, Waage, …"></textarea>
        </div>
      </div>

      <div class="results" id="results"></div>

      <div class="toolbar">
        <button id="exportCsv" type="button" class="secondary">Export CSV</button>
        <button id="clearAll" type="button" class="danger">Alles löschen</button>
        <span class="muted">Fotos & Daten werden lokal gespeichert.</span>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Ort (Link)</th>
              <th class="right">Max</th>
              <th class="right">Gemessen</th>
              <th class="right">Nach Tol.</th>
              <th class="right">Übergewicht</th>
              <th class="right">Überladen</th>
              <th class="right">Abw.</th>
              <th>Status</th>
              <th>Foto</th>
              <th>Notiz</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:12px; line-height:1.35;">
        PDF Hinweis (iPhone): Druckansicht → „Teilen“ → „In Dateien sichern“ = PDF.
      </div>

    </div>
  </div>

  <!-- Bottom Bar (Buttons unten) -->
  <div class="bottomBar">
    <div class="bottomInner">
      <div class="left">
        <button id="openSettings" type="button" class="secondary">Einstellungen</button>
        <button id="pdfCurrent" type="button" class="secondary">PDF</button>
      </div>
      <div class="right">
        <button id="save" type="button">Speichern</button>
        <button id="reset" type="button" class="secondary">Reset</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalOverlay" id="settingsOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0; font-size:16px;">Einstellungen</h2>
        <button id="closeSettings" type="button" class="secondary">Schließen</button>
      </div>

      <div class="optRow">
        <div>
          <div style="font-weight:900;">Darstellung</div>
          <div class="small">Auto = System, Hell/Dunkel erzwingen</div>
        </div>
        <div class="switch">
          <button id="themeAuto" type="button">AUTO</button>
          <button id="themeLight" type="button">HELL</button>
          <button id="themeDark" type="button">DUNKEL</button>
        </div>
      </div>

      <div class="optRow">
        <div>
          <div style="font-weight:900;">Warnmodus</div>
          <div class="small">Rote Warnfarbe bei Überschreitung</div>
        </div>
        <div class="switch">
          <button id="warnOn" type="button">AN</button>
          <button id="warnOff" type="button">AUS</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Quick visible "JS runs" indicator
  var jsStatus = document.getElementById("jsStatus");
  if (jsStatus) jsStatus.textContent = "JS läuft ✅";

  var root = document.documentElement;
  var card = document.getElementById("card");

  var elMax = document.getElementById("max");
  var elMeasured = document.getElementById("measured");
  var elTol = document.getElementById("tol");
  var elLimit = document.getElementById("limit");
  var elNote = document.getElementById("note");

  var elPhoto = document.getElementById("photo");
  var elPhotoPreview = document.getElementById("photoPreview");
  var btnClearPhoto = document.getElementById("clearPhoto");

  var results = document.getElementById("results");
  var historyBody = document.getElementById("historyBody");

  var saveBtn = document.getElementById("save");
  var resetBtn = document.getElementById("reset");
  var exportBtn = document.getElementById("exportCsv");
  var clearAllBtn = document.getElementById("clearAll");
  var offlineBar = document.getElementById("offlineBar");

  var btnPdfCurrent = document.getElementById("pdfCurrent");

  var settingsOverlay = document.getElementById("settingsOverlay");
  var openSettings = document.getElementById("openSettings");
  var closeSettings = document.getElementById("closeSettings");

  var btnThemeAuto = document.getElementById("themeAuto");
  var btnThemeLight = document.getElementById("themeLight");
  var btnThemeDark = document.getElementById("themeDark");

  var btnWarnOn = document.getElementById("warnOn");
  var btnWarnOff = document.getElementById("warnOff");

  var STORAGE_KEY = "gewicht_app_history_v8";
  var THEME_KEY = "gewicht_theme_mode_v4";
  var WARN_KEY  = "gewicht_warn_enabled_v3";

  var warnEnabled = true;
  var currentPhotoDataUrl = null;

  function parseNum(s){
    if (typeof s !== "string") return NaN;
    var normalized = s.trim().replace(/\s+/g, "").replace(",", ".");
    var v = Number(normalized);
    return Number.isFinite(v) ? v : NaN;
  }
  function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
  function roundPct2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

  function nowLocalString(){
    var d = new Date();
    var pad = function(n){ return String(n).padStart(2, "0"); };
    return pad(d.getDate()) + "." + pad(d.getMonth()+1) + "." + d.getFullYear() + " " + pad(d.getHours()) + ":" + pad(d.getMinutes());
  }

  function googleMapsLink(lat, lon){
    return "https://www.google.com/maps?q=" + lat + "," + lon;
  }

  function setTheme(mode){
    root.setAttribute("data-theme", mode);
    localStorage.setItem(THEME_KEY, mode);
    btnThemeAuto.classList.toggle("active", mode === "auto");
    btnThemeLight.classList.toggle("active", mode === "light");
    btnThemeDark.classList.toggle("active", mode === "dark");
  }

  function setWarnMode(on){
    warnEnabled = !!on;
    localStorage.setItem(WARN_KEY, warnEnabled ? "1" : "0");
    btnWarnOn.classList.toggle("active", warnEnabled);
    btnWarnOff.classList.toggle("active", !warnEnabled);
    render();
  }

  // Init settings
  (function(){
    var savedTheme = localStorage.getItem(THEME_KEY) || "auto";
    setTheme(savedTheme);
    var savedWarn = localStorage.getItem(WARN_KEY);
    setWarnMode(savedWarn === null ? true : savedWarn === "1");
  })();

  // Modal
  openSettings.addEventListener("click", function(){ settingsOverlay.style.display = "flex"; });
  closeSettings.addEventListener("click", function(){ settingsOverlay.style.display = "none"; });
  settingsOverlay.addEventListener("click", function(e){ if (e.target === settingsOverlay) settingsOverlay.style.display = "none"; });

  btnThemeAuto.addEventListener("click", function(){ setTheme("auto"); });
  btnThemeLight.addEventListener("click", function(){ setTheme("light"); });
  btnThemeDark.addEventListener("click", function(){ setTheme("dark"); });

  btnWarnOn.addEventListener("click", function(){ setWarnMode(true); });
  btnWarnOff.addEventListener("click", function(){ setWarnMode(false); });

  async function fileToCompressedDataURL(file){
    var bitmap = await createImageBitmap(file);
    var maxSide = 1280;
    var w = bitmap.width, h = bitmap.height;
    var scale = Math.min(1, maxSide / Math.max(w, h));
    w = Math.round(w * scale);
    h = Math.round(h * scale);

    var canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0, w, h);
    return canvas.toDataURL("image/jpeg", 0.75);
  }

  elPhoto.addEventListener("change", async function(){
    var f = elPhoto.files && elPhoto.files[0];
    if (!f) return;
    try{
      currentPhotoDataUrl = await fileToCompressedDataURL(f);
      elPhotoPreview.src = currentPhotoDataUrl;
      elPhotoPreview.style.display = "block";
      btnClearPhoto.style.display = "inline-block";
    }catch(err){
      alert("Foto konnte nicht verarbeitet werden.");
      currentPhotoDataUrl = null;
      elPhoto.value = "";
    }
  });

  btnClearPhoto.addEventListener("click", function(){
    currentPhotoDataUrl = null;
    elPhoto.value = "";
    elPhotoPreview.src = "";
    elPhotoPreview.style.display = "none";
    btnClearPhoto.style.display = "none";
  });

  function calc(){
    var max = parseNum(elMax.value);
    var measured = parseNum(elMeasured.value);
    var tolPct = parseNum(elTol.value) / 100;
    var limitPct = parseNum(elLimit.value) / 100;

    var ok = Number.isFinite(max) && max > 0 && Number.isFinite(measured) && Number.isFinite(tolPct) && Number.isFinite(limitPct);
    if (!ok) return { ok:false };

    var afterTol = round2(measured * (1 - tolPct));
    var overweightKg = round2(Math.max(0, afterTol - max));
    var overloadPercent = roundPct2(Math.max(0, (afterTol - max) / max * 100));
    var deviationPercent = roundPct2(((afterTol - max) / max) * 100);

    var threshold = round2(max * (1 + limitPct));
    var exceeded = afterTol > threshold;

    return { ok:true, max:round2(max), measured:round2(measured), tolPct:tolPct, limitPct:limitPct, afterTol:afterTol, overweightKg:overweightKg, overloadPercent:overloadPercent, deviationPercent:deviationPercent, exceeded:exceeded };
  }

  function render(){
    var c = calc();
    if (!c.ok){
      card.classList.remove("warn");
      results.innerHTML =
        '<div class="pill"><span>Gemessen nach Toleranzabzug</span><strong>—</strong></div>' +
        '<div class="pill"><span>Übergewicht (kg)</span><strong>—</strong></div>' +
        '<div class="pill"><span>Überladen (%)</span><strong>—</strong></div>' +
        '<div class="pill"><span>Abweichung zum Maximum (%)</span><strong>—</strong></div>' +
        '<div class="pill"><span>Mehr als Grenze über Max?</span><strong>—</strong></div>';
      return;
    }

    card.classList.toggle("warn", warnEnabled && c.exceeded);
    var statusClass = (warnEnabled && c.exceeded) ? "bad" : "ok";
    var statusText = c.exceeded ? "JA" : "NEIN";

    results.innerHTML =
      '<div class="pill"><span>Gemessen nach Toleranzabzug</span><strong>' + c.afterTol.toFixed(2) + ' kg</strong></div>' +
      '<div class="pill"><span>Übergewicht (kg)</span><strong>' + c.overweightKg.toFixed(2) + ' kg</strong></div>' +
      '<div class="pill"><span>Überladen (%)</span><strong>' + c.overloadPercent.toFixed(2) + ' %</strong></div>' +
      '<div class="pill"><span>Abweichung zum Maximum (%)</span><strong>' + c.deviationPercent.toFixed(2) + ' %</strong></div>' +
      '<div class="pill ' + statusClass + '"><span>Mehr als ' + (c.limitPct*100).toFixed(2) + ' % über Max?</span><strong>' + statusText + '</strong></div>';
  }

  function getLocationOnce(timeoutMs){
    return new Promise(function(resolve){
      if (!("geolocation" in navigator)) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        function(pos){ resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy }); },
        function(){ resolve(null); },
        { enableHighAccuracy: true, timeout: timeoutMs || 7000, maximumAge: 60000 }
      );
    });
  }

  function loadHistory(){
    try{
      var raw = localStorage.getItem(STORAGE_KEY);
      var arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveHistory(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

  function renderHistory(){
    var arr = loadHistory();
    if (arr.length === 0){
      historyBody.innerHTML = '<tr><td colspan="12" class="muted">Noch keine gespeicherten Messungen.</td></tr>';
      return;
    }

    historyBody.innerHTML = arr.map(function(e, idx){
      var chipClass = e.exceeded ? "chip bad" : "chip ok";
      var chipText = e.exceeded ? "Überschritten" : "OK";
      var safeNote = (e.note || "").replaceAll("<","&lt;").replaceAll(">","&gt;");

      var locHtml = "—";
      if (e.location && Number.isFinite(e.location.lat) && Number.isFinite(e.location.lon)){
        var url = googleMapsLink(e.location.lat, e.location.lon);
        locHtml = '<a href="' + url + '" target="_blank" rel="noopener">Google Maps</a>';
      }

      var thumb = e.photoDataUrl ? '<img class="thumb" src="' + e.photoDataUrl + '" alt="Foto">' : "—";

      return (
        '<tr>' +
          '<td>' + e.date + '</td>' +
          '<td>' + locHtml + '</td>' +
          '<td class="right">' + Number(e.max).toFixed(2) + '</td>' +
          '<td class="right">' + Number(e.measured).toFixed(2) + '</td>' +
          '<td class="right">' + Number(e.afterTol).toFixed(2) + '</td>' +
          '<td class="right">' + Number(e.overweightKg).toFixed(2) + '</td>' +
          '<td class="right">' + Number(e.overloadPercent).toFixed(2) + ' %</td>' +
          '<td class="right">' + Number(e.deviationPercent).toFixed(2) + ' %</td>' +
          '<td><span class="' + chipClass + '">' + chipText + '</span></td>' +
          '<td>' + thumb + '</td>' +
          '<td>' + safeNote + '</td>' +
          '<td class="right"><button class="secondary" data-del="' + idx + '" type="button">Löschen</button></td>' +
        '</tr>'
      );
    }).join("");

    historyBody.querySelectorAll("button[data-del]").forEach(function(btn){
      btn.addEventListener("click", function(){
        var i = Number(btn.getAttribute("data-del"));
        var arr2 = loadHistory();
        arr2.splice(i, 1);
        saveHistory(arr2);
        renderHistory();
      });
    });
  }

  async function onSave(){
    var c = calc();
    if (!c.ok){
      alert("Bitte gültige Zahlen eingeben (Max > 0, gemessen, Toleranz, Grenze).");
      return;
    }

    var loc = await getLocationOnce(7000);

    var entry = {
      date: nowLocalString(),
      max: c.max,
      measured: c.measured,
      tolPercent: roundPct2(c.tolPct * 100),
      limitPercent: roundPct2(c.limitPct * 100),
      afterTol: c.afterTol,
      overweightKg: c.overweightKg,
      overloadPercent: c.overloadPercent,
      deviationPercent: c.deviationPercent,
      exceeded: c.exceeded,
      note: elNote.value.trim(),
      photoDataUrl: currentPhotoDataUrl,
      location: loc
    };

    var arr = loadHistory();
    arr.unshift(entry);
    saveHistory(arr);
    renderHistory();

    elNote.value = "";
    btnClearPhoto.click();

    if (warnEnabled && entry.exceeded && navigator.vibrate){
      try { navigator.vibrate([80,80,80]); } catch(e){}
    }
  }

  function onReset(){
    elMax.value = "";
    elMeasured.value = "";
    elTol.value = "3";
    elLimit.value = "5";
    elNote.value = "";
    btnClearPhoto.click();
    render();
  }

  function exportCSV(){
    var arr = loadHistory();
    if (arr.length === 0){ alert("Keine Daten zum Exportieren."); return; }

    var header = ["Datum","Maps_Link","Max_kg","Gemessen_kg","Toleranz_%","Grenze_%","NachTol_kg","Übergewicht_kg","Überladen_%","Abweichung_%","Überschritten","Notiz"];
    var rows = arr.map(function(e){
      var map = (e.location && Number.isFinite(e.location.lat)) ? googleMapsLink(e.location.lat, e.location.lon) : "";
      return [
        e.date, map,
        Number(e.max).toFixed(2),
        Number(e.measured).toFixed(2),
        Number(e.tolPercent).toFixed(2),
        Number(e.limitPercent).toFixed(2),
        Number(e.afterTol).toFixed(2),
        Number(e.overweightKg).toFixed(2),
        Number(e.overloadPercent).toFixed(2),
        Number(e.deviationPercent).toFixed(2),
        e.exceeded ? "JA" : "NEIN",
        (e.note || "").replaceAll('"','""')
      ];
    });

    var csv = [header.join(",")].concat(rows.map(function(r){
      return r.map(function(v){
        var s = String(v);
        return /[",\n]/.test(s) ? '"' + s.replaceAll('"','""') + '"' : s;
      }).join(",");
    })).join("\n");

    var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "gewicht-messungen.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearAll(){
    if (!confirm("Wirklich alle gespeicherten Messungen löschen?")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }

  function openPrintCurrent(){
    var c = calc();
    if (!c.ok){ alert("Bitte zuerst gültige Werte eingeben."); return; }
    var entry = {
      date: nowLocalString(),
      max: c.max,
      measured: c.measured,
      tolPercent: roundPct2(c.tolPct * 100),
      limitPercent: roundPct2(c.limitPct * 100),
      afterTol: c.afterTol,
      overweightKg: c.overweightKg,
      overloadPercent: c.overloadPercent,
      deviationPercent: c.deviationPercent,
      exceeded: c.exceeded,
      note: elNote.value.trim(),
      photoDataUrl: currentPhotoDataUrl,
      location: null
    };

    var status = entry.exceeded ? "ÜBERSCHRITTEN" : "OK";
    var statusColor = entry.exceeded ? "#c62828" : "#2e7d32";
    var imgHtml = entry.photoDataUrl ? '<img src="' + entry.photoDataUrl + '" style="width:100%;max-width:520px;border-radius:14px;border:1px solid #ddd;" />' : '<div style="color:#666">Kein Foto</div>';

    var html =
'<!doctype html><html lang="de"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">' +
'<title>Messprotokoll</title><style>' +
'body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111;}' +
'.head{display:flex;align-items:center;gap:14px;margin-bottom:16px;}' +
'.logo{width:72px;height:auto;}' +
'h1{font-size:18px;margin:0;}' +
'.muted{color:#666;font-size:12px;margin-top:2px;word-break:break-word;}' +
'.box{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin-top:12px;}' +
'.row{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #eee;}' +
'.row:last-child{border-bottom:0;}' +
'.status{display:inline-block;padding:6px 10px;border-radius:999px;color:#fff;font-weight:800;background:' + statusColor + ';}' +
'@media print{body{margin:0;}}' +
'</style></head><body>' +
'<div class="head"><img src="logo_round_256.png" class="logo" alt="Logo"><div>' +
'<h1>Messprotokoll – Gewichtsprüfung</h1>' +
'<div class="muted">Datum/Zeit: ' + entry.date + '</div>' +
'</div></div>' +
'<div class="box">' +
'<div class="row"><span>Status</span><span class="status">' + status + '</span></div>' +
'<div class="row"><span>Maximalgewicht</span><strong>' + Number(entry.max).toFixed(2) + ' kg</strong></div>' +
'<div class="row"><span>Gemessen</span><strong>' + Number(entry.measured).toFixed(2) + ' kg</strong></div>' +
'<div class="row"><span>Nach Toleranz</span><strong>' + Number(entry.afterTol).toFixed(2) + ' kg</strong></div>' +
'<div class="row"><span>Überladen</span><strong>' + Number(entry.overloadPercent).toFixed(2) + ' %</strong></div>' +
'<div class="box"><div class="muted" style="margin-bottom:8px;">Foto</div>' + imgHtml + '</div>' +
'</div>' +
'<script>setTimeout(function(){window.print();},300);</script>' +
'</body></html>';

    var w = window.open("", "_blank");
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  btnPdfCurrent.addEventListener("click", openPrintCurrent);

  function updateOfflineBanner(){ offlineBar.style.display = navigator.onLine ? "none" : "block"; }
  window.addEventListener("online", updateOfflineBanner);
  window.addEventListener("offline", updateOfflineBanner);

  saveBtn.addEventListener("click", onSave);
  resetBtn.addEventListener("click", onReset);
  exportBtn.addEventListener("click", exportCSV);
  clearAllBtn.addEventListener("click", clearAll);

  [elMax, elMeasured, elTol, elLimit].forEach(function(el){ el.addEventListener("input", render); });

  render();
  renderHistory();
  updateOfflineBanner();

  // Service Worker
  if ("serviceWorker" in navigator){
    window.addEventListener("load", function(){
      navigator.serviceWorker.register("./sw.js").catch(function(){});
    });
  }
})();
</script>
</body>
</html>
