<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gewichtsprüfung</title>

  <!-- iPhone Home-Screen / App-Style -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Gewicht">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#111111">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="icon-192.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <style>
    /* ---------- Theme (Light default) ---------- */
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111111;
      --muted: #666666;
      --border: #e3e6f2;

      --pill: #f2f4ff;
      --ok: #e9fbf0;
      --bad: #ffecec;

      --btn: #111111;
      --btnText: #ffffff;
      --btnSecondary: #eef0f8;
      --btnSecondaryText: #111111;

      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --focus: 0 0 0 3px rgba(107,124,255,.15);
      --focusBorder: #6b7cff;
    }

    /* ---------- Dark Mode automatic ---------- */
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b0d12;
        --card: #121521;
        --text: #f2f3f5;
        --muted: #a8b0c0;
        --border: #232a3b;

        --pill: #171c2a;
        --ok: rgba(46, 204, 113, .15);
        --bad: rgba(231, 76, 60, .18);

        --btn: #f2f3f5;
        --btnText: #111111;
        --btnSecondary: #1b2133;
        --btnSecondaryText: #f2f3f5;

        --shadow: 0 10px 30px rgba(0,0,0,.45);
        --focus: 0 0 0 3px rgba(107,124,255,.25);
        --focusBorder: #8b97ff;
      }
    }

    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width: 940px; margin: 0 auto; padding: 18px; padding-bottom: 36px; }
    .card { background:var(--card); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); }

    .header{
      display:flex; flex-direction: column; align-items:center; justify-content:center;
      gap: 6px; margin-top: 6px;
    }
    .appLogo{
      display:block;
      width: 92px;
      height: auto;
      margin: 10px auto 2px auto;
    }
    h1 { font-size: 20px; margin: 0; text-align:center; }
    .sub { font-size: 12px; color:var(--muted); text-align:center; margin: 0 0 6px; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 740px){ .grid { grid-template-columns: 1fr; } }

    label { display:block; font-size: 12px; color:var(--muted); margin-bottom: 6px; }
    input, textarea {
      width:100%; padding: 12px 12px; font-size: 16px;
      border:1px solid var(--border); border-radius: 12px; outline:none; background:var(--card); color:var(--text);
    }
    input:focus, textarea:focus { border-color: var(--focusBorder); box-shadow: var(--focus); }
    textarea { min-height: 44px; resize: vertical; }

    .muted { color:var(--muted); font-size: 12px; margin-top: 6px; line-height: 1.25; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }

    button{
      cursor:pointer; border:0; padding: 12px 14px; border-radius: 12px;
      background:var(--btn); color:var(--btnText); font-weight: 800; font-size: 15px;
    }
    button.secondary { background:var(--btnSecondary); color:var(--btnSecondaryText); }
    button.danger { background:#c62828; color:#fff; }
    button:active { transform: translateY(1px); }

    .results { margin-top: 14px; display:grid; gap:10px; }
    .pill{
      display:flex; justify-content:space-between; gap:12px;
      padding: 12px; border-radius: 14px; background:var(--pill);
    }
    .pill strong { font-weight: 900; }
    .ok { background:var(--ok); }
    .bad { background:var(--bad); }

    .toolbar { margin-top: 12px; display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    .tableWrap { margin-top: 12px; overflow:auto; border:1px solid var(--border); border-radius: 12px; }
    table { width:100%; border-collapse: collapse; min-width: 860px; }
    th, td { padding: 10px 10px; border-bottom: 1px solid rgba(227,230,242,.45); font-size: 14px; text-align:left; }
    @media (prefers-color-scheme: dark){
      th, td { border-bottom: 1px solid rgba(35,42,59,.85); }
    }
    th { font-size: 12px; color:var(--muted); background: rgba(250,251,255,.6); position: sticky; top: 0; }
    @media (prefers-color-scheme: dark){
      th { background: rgba(27,33,51,.75); }
    }
    tr:last-child td { border-bottom: 0; }
    .right { text-align:right; }

    .chip { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 900; }
    .chip.ok { background:var(--ok); }
    .chip.bad { background:var(--bad); }

    .foot { margin-top: 12px; font-size: 12px; color:var(--muted); line-height: 1.35; }

    /* Offline badge */
    .offlineBar{
      display:none;
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 193, 7, .15);
      border: 1px solid rgba(255, 193, 7, .35);
      color: var(--text);
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="header">
        <img src="logo_round_256.png" alt="Logo" class="appLogo">
        <h1>Gewichtsprüfung</h1>
        <p class="sub">Offline & Dark Mode • Toleranz • Überladen-% • Speicherung • CSV</p>
      </div>

      <div class="offlineBar" id="offlineBar">⚠️ Offline-Modus aktiv (du bist gerade ohne Internet).</div>

      <div class="grid">
        <div>
          <label for="max">Maximalgewicht (kg)</label>
          <input id="max" type="text" inputmode="decimal" placeholder="z.B. 100,00" autocomplete="off" />
        </div>

        <div>
          <label for="measured">Gemessenes Gewicht (kg)</label>
          <input id="measured" type="text" inputmode="decimal" placeholder="z.B. 104,50" autocomplete="off" />
        </div>

        <div>
          <label for="tol">Toleranzabzug (%)</label>
          <input id="tol" type="text" inputmode="decimal" value="3" autocomplete="off" />
          <div class="muted">Wird vom gemessenen Gewicht abgezogen</div>
        </div>

        <div>
          <label for="limit">Überschreitungs-Grenze (%)</label>
          <input id="limit" type="text" inputmode="decimal" value="5" autocomplete="off" />
          <div class="muted">„JA“, wenn (nach Toleranz) &gt; Max × (1 + Grenze)</div>
        </div>

        <div style="grid-column: 1 / -1;">
          <label for="note">Notiz (optional)</label>
          <textarea id="note" placeholder="z.B. Auftrag, Ort, Waage, …"></textarea>
        </div>

        <div class="row" style="grid-column: 1 / -1;">
          <button id="save" type="button">Messung speichern</button>
          <button id="reset" type="button" class="secondary">Zurücksetzen</button>
          <span class="muted">Eingaben ändern → Ergebnis aktualisiert automatisch.</span>
        </div>
      </div>

      <div class="results" id="results"></div>

      <div class="toolbar">
        <button id="exportCsv" type="button" class="secondary">Export CSV</button>
        <button id="clearAll" type="button" class="danger">Alles löschen</button>
        <span class="muted">Speicherung lokal in Safari auf deinem Gerät.</span>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th class="right">Max (kg)</th>
              <th class="right">Gemessen (kg)</th>
              <th class="right">Nach Tol. (kg)</th>
              <th class="right">Übergewicht (kg)</th>
              <th class="right">Überladen (%)</th>
              <th class="right">Abw. (%)</th>
              <th>Status</th>
              <th>Notiz</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div class="foot">
        Formeln (stabile Rundung):
        nach Toleranz = gemessen × (1 − Toleranz%),
        Übergewicht kg = max(0, nach Toleranz − Max),
        Überladen % = max(0, (nach Toleranz − Max)/Max × 100),
        Überschritten? nach Toleranz &gt; Max × (1 + Grenze%).
      </div>

    </div>
  </div>

<script>
  const elMax = document.getElementById("max");
  const elMeasured = document.getElementById("measured");
  const elTol = document.getElementById("tol");
  const elLimit = document.getElementById("limit");
  const elNote = document.getElementById("note");

  const results = document.getElementById("results");
  const historyBody = document.getElementById("historyBody");

  const saveBtn = document.getElementById("save");
  const resetBtn = document.getElementById("reset");
  const exportBtn = document.getElementById("exportCsv");
  const clearAllBtn = document.getElementById("clearAll");

  const offlineBar = document.getElementById("offlineBar");

  const STORAGE_KEY = "gewicht_app_history_v4";

  function parseNum(s) {
    if (typeof s !== "string") return NaN;
    const normalized = s.trim().replace(/\\s+/g, "").replace(",", ".");
    const v = Number(normalized);
    return Number.isFinite(v) ? v : NaN;
  }

  const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
  const roundPct2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;

  function nowLocalString() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function calc() {
    const max = parseNum(elMax.value);
    const measured = parseNum(elMeasured.value);
    const tolPct = parseNum(elTol.value) / 100;
    const limitPct = parseNum(elLimit.value) / 100;

    const ok =
      Number.isFinite(max) && max > 0 &&
      Number.isFinite(measured) &&
      Number.isFinite(tolPct) &&
      Number.isFinite(limitPct);

    if (!ok) return { ok:false };

    const afterTol = round2(measured * (1 - tolPct));
    const overweightKg = round2(Math.max(0, afterTol - max));
    const overloadPercent = roundPct2(Math.max(0, (afterTol - max) / max * 100));
    const deviationPercent = roundPct2(((afterTol - max) / max) * 100);

    const threshold = round2(max * (1 + limitPct));
    const exceeded = afterTol > threshold;

    return {
      ok:true,
      max: round2(max),
      measured: round2(measured),
      tolPct,
      limitPct,
      afterTol,
      overweightKg,
      overloadPercent,
      deviationPercent,
      exceeded
    };
  }

  function render() {
    const c = calc();
    if (!c.ok) {
      results.innerHTML = `
        <div class="pill"><span>Gemessen nach Toleranzabzug</span><strong>—</strong></div>
        <div class="pill"><span>Übergewicht (kg)</span><strong>—</strong></div>
        <div class="pill"><span>Überladen (%)</span><strong>—</strong></div>
        <div class="pill"><span>Abweichung zum Maximum (%)</span><strong>—</strong></div>
        <div class="pill"><span>Mehr als Grenze über Max?</span><strong>—</strong></div>
      `;
      return;
    }

    const statusClass = c.exceeded ? "bad" : "ok";
    const statusText = c.exceeded ? "JA" : "NEIN";

    results.innerHTML = `
      <div class="pill">
        <span>Gemessen nach Toleranzabzug</span>
        <strong>${c.afterTol.toFixed(2)} kg</strong>
      </div>
      <div class="pill">
        <span>Übergewicht (kg)</span>
        <strong>${c.overweightKg.toFixed(2)} kg</strong>
      </div>
      <div class="pill">
        <span>Überladen (%)</span>
        <strong>${c.overloadPercent.toFixed(2)} %</strong>
      </div>
      <div class="pill">
        <span>Abweichung zum Maximum (%)</span>
        <strong>${c.deviationPercent.toFixed(2)} %</strong>
      </div>
      <div class="pill ${statusClass}">
        <span>Mehr als ${(c.limitPct*100).toFixed(2)} % über Max?</span>
        <strong>${statusText}</strong>
      </div>
    `;
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  function saveHistory(arr) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }

  function renderHistory() {
    const arr = loadHistory();
    if (arr.length === 0) {
      historyBody.innerHTML = `<tr><td colspan="10" class="muted">Noch keine gespeicherten Messungen.</td></tr>`;
      return;
    }

    historyBody.innerHTML = arr.map((e, idx) => {
      const chipClass = e.exceeded ? "chip bad" : "chip ok";
      const chipText = e.exceeded ? "Überschritten" : "OK";
      const safeNote = (e.note || "").replaceAll("<","&lt;").replaceAll(">","&gt;");
      return `
        <tr>
          <td>${e.date}</td>
          <td class="right">${Number(e.max).toFixed(2)}</td>
          <td class="right">${Number(e.measured).toFixed(2)}</td>
          <td class="right">${Number(e.afterTol).toFixed(2)}</td>
          <td class="right">${Number(e.overweightKg).toFixed(2)}</td>
          <td class="right">${Number(e.overloadPercent).toFixed(2)} %</td>
          <td class="right">${Number(e.deviationPercent).toFixed(2)} %</td>
          <td><span class="${chipClass}">${chipText}</span></td>
          <td>${safeNote}</td>
          <td class="right"><button class="secondary" data-del="${idx}" type="button">Löschen</button></td>
        </tr>
      `;
    }).join("");

    historyBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        const arr2 = loadHistory();
        arr2.splice(i, 1);
        saveHistory(arr2);
        renderHistory();
      });
    });
  }

  function onSave() {
    const c = calc();
    if (!c.ok) {
      alert("Bitte gültige Zahlen eingeben (Max > 0, gemessen, Toleranz, Grenze).");
      return;
    }

    const entry = {
      date: nowLocalString(),
      max: c.max,
      measured: c.measured,
      tolPercent: roundPct2(c.tolPct * 100),
      limitPercent: roundPct2(c.limitPct * 100),
      afterTol: c.afterTol,
      overweightKg: c.overweightKg,
      overloadPercent: c.overloadPercent,
      deviationPercent: c.deviationPercent,
      exceeded: c.exceeded,
      note: elNote.value.trim()
    };

    const arr = loadHistory();
    arr.unshift(entry);
    saveHistory(arr);
    renderHistory();
    elNote.value = "";
  }

  function exportCSV() {
    const arr = loadHistory();
    if (arr.length === 0) { alert("Keine Daten zum Exportieren."); return; }

    const header = [
      "Datum","Max_kg","Gemessen_kg","Toleranz_%","Grenze_%",
      "NachTol_kg","Übergewicht_kg","Überladen_%","Abweichung_%","Überschritten","Notiz"
    ];

    const rows = arr.map(e => [
      e.date,
      Number(e.max).toFixed(2),
      Number(e.measured).toFixed(2),
      Number(e.tolPercent).toFixed(2),
      Number(e.limitPercent).toFixed(2),
      Number(e.afterTol).toFixed(2),
      Number(e.overweightKg).toFixed(2),
      Number(e.overloadPercent).toFixed(2),
      Number(e.deviationPercent).toFixed(2),
      e.exceeded ? "JA" : "NEIN",
      (e.note || "").replaceAll('"','""')
    ]);

    const csv = [header.join(","), ...rows.map(r => r.map(v => {
      const s = String(v);
      return /[",\\n]/.test(s) ? `"${s}"` : s;
    }).join(","))].join("\\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gewicht-messungen.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearAll() {
    if (!confirm("Wirklich alle gespeicherten Messungen löschen?")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }

  function onReset() {
    elMax.value = "";
    elMeasured.value = "";
    elTol.value = "3";
    elLimit.value = "5";
    elNote.value = "";
    render();
  }

  function updateOfflineBanner() {
    offlineBar.style.display = navigator.onLine ? "none" : "block";
  }
  window.addEventListener("online", updateOfflineBanner);
  window.addEventListener("offline", updateOfflineBanner);

  [elMax, elMeasured, elTol, elLimit].forEach(el => el.addEventListener("input", render));
  saveBtn.addEventListener("click", onSave);
  resetBtn.addEventListener("click", onReset);
  exportBtn.addEventListener("click", exportCSV);
  clearAllBtn.addEventListener("click", clearAll);

  render();
  renderHistory();
  updateOfflineBanner();

  // ---- OFFLINE (Service Worker) ----
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
</script>
</body>
</html>
